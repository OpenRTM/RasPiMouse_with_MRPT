
<!DOCTYPE html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RaspberryPiMouseのセットアップ &#8212; Navigation  ドキュメント</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/translations.js"></script>
    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Navigation  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RaspberryPiMouseのセットアップ</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="raspberrypimouse">
<h1>RaspberryPiMouseのセットアップ<a class="headerlink" href="#raspberrypimouse" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="raspberrypi-3b-os">
<h2>RaspberryPi 3B+へOSのインストール<a class="headerlink" href="#raspberrypi-3b-os" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>RasPiMouse2019のハードウェアの組み立ての前に、搭載するCPUボード(RaspberryPi 3B+)に
OSのインストールとRasPiMouse2019の各種デバイスを動作させるためのデバイスドライバのインストールを行ってください。</p>
<div class="section" id="raspberrypi-3b-raspbian">
<h3>RaspberryPi 3B+にRaspbianをインストール<a class="headerlink" href="#raspberrypi-3b-raspbian" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>Raspbianのインストールは、<a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">オフィシャルサイト</a>
から Raspbian (Raspberry Pi OS) または <a class="reference external" href="https://www.raspberrypi.org/downloads/noobs/">NOOBS</a>
をダウンロードしてOSをインストールします。</p>
</div>
<div class="section" id="raspbian-raspberry-pi-os">
<h3>Raspbian (Raspberry Pi OS) を直接インストール<a class="headerlink" href="#raspbian-raspberry-pi-os" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>オフィシャルサイトの <a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian ダウンロードサイト</a>
からOSイメージをダウンロードして、SDカードに書き込みます。なお、このドキュメント執筆時点では、以下の３種類のOSが
ダウンロード可能でしたが、RaspberryPiMouseを動作させる場合には Lite 版で十分ですので、サイズの小さい
Lite 版をインストールすることをお勧めします。ただし、このイメージではGUIでの操作ができないので、
コマンドライン操作に自信がない場合は、サイズ中の desktop 版をインストールします。</p>
<ul class="simple">
<li><p>Raspberry Pi OS (32-bit) with desktop and recommended software (サイズ大、インストール時間長、推奨)</p></li>
<li><p>Raspberry Pi OS (32-bit) with desktop (サイズ中、インストール時間中、推奨)</p></li>
<li><p>Raspberry Pi OS (32-bit) Lite (サイズ小、インストール時間短、推奨)</p></li>
</ul>
<p>イメージとは、ディスクの0バイト目から最後までを一つのファイルにしたものであり、これをイメージ書き込みツールなどで
SDカードやHDD/SSDなど起動可能なディスクに書き込むと、OSをそのディスクにインストールしたものと同じ状態になる
一つの大きなファイルのことを指します。</p>
<p>基本的な方法は、上記ダウンロードサイトから、RaspbianのOSイメージを選択・ダウンロードし、イメージ書き込みツールで
SDカードへの書き込むことで行います。詳細な方法についてはWeb上に多数のドキュメントがありますのでそれらを参照してください。
主なドキュメントを以下に示します。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qiita.com/s_harada/items/3ba9f660f66bc74d1746">Qiita 「Raspberry Pi OS(Raspbian)インストールと初期セットアップ」</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/desucru/items/ccd382aec0628007dc48">Qiita 「Raspbian Busterのインストール」</a></p></li>
</ul>
</div>
<div class="section" id="noobs-raspbian">
<h3>NOOBS から Raspbian をインストール<a class="headerlink" href="#noobs-raspbian" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>NOOBSは、上記より簡単な方法で、様々なOSをインストールする方法を提供するツールです。
SDカードの書き込みに特別なツールは必要ありませんし、多数のOSの中からインストール時に好きなOSを
選ぶことができます。オフィシャルサイトの <a class="reference external" href="https://www.raspberrypi.org/downloads/noobs/">NOOOBS ダウンロードサイト</a>
からNOOBSをダウンロードして、SDカードに書き込みます。NOOBSは以下の２種類あり、ネットワークがつながる場合には、Lite版が利用可能です。</p>
<ul class="simple">
<li><p>NOOBS （サイズ大、ネットワーク不要)</p></li>
<li><p>NOOBS Lite (サイズ小、ネットワーク必要、推奨)</p></li>
</ul>
<p>NOOBSを利用したインストール方法の概要はおおよそ以下の通りです。</p>
<ul class="simple">
<li><p>NOOBSファイル (NOOBS.zip) をダウンロード</p></li>
<li><p>SDカードをフォーマッタでフォーマット</p></li>
<li><p>NOOBS.zip を解凍して展開されたフィアルをSDカードにコピーする</p></li>
<li><p>RaspberryPi にSDカードを挿し起動する</p></li>
<li><p>GUIメニューでOSを選択、その後自動でインストールが完了</p></li>
</ul>
<p>詳細な方法についてはWeb上に多数のドキュメントがありますのでそれらを参照してください。
主なドキュメントを以下に示します。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qiita.com/halchiyo/items/8a03db32e726ecddb0aa">Qiita「Raspbian ネットインストール」</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/MEGAMAN__HS/items/2ac62c260e85b1bea6ad">Qiita「RaspberryPi 3 Model B+ の設定　機材からOSのインストールまで【備忘録】」</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/SatomiWatanabe/items/e2773b0c87d3c32473ac">Qiita「Raspberry Pi への Raspbian インストール方法」</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/takabye/items/03ad86a23226a12e4417">Qiita「Raspberry pi 3 Model B セットアップしてみた。」</a></p></li>
</ul>
<p>また、NOOBSは工夫すると、事前にssh (リモートログインに必要)やVNC (リモートで画面表示しつつRaspberryPiを操作可能)、
WIFIなどを設定することができるため、RaspberryPiに接続するキーボードやディスプレイを用意する必要がなくなります。
その方法については、Web情に多数のドキュメントがありますが、その一つをいかに示します。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://qiita.com/horidaisuke/items/f3a6955c2015fab76f2c">Qiita「Raspberry Piにディスプレイとマウスとキーボートを繋がずに自動でRaspbianをインストールする」</a></p></li>
</ul>
<p>インストール終了後、ネットワークに接続してOSのアップデートを行ってください。</p>
</div>
<div class="section" id="cui">
<h3>起動モードをCUIに変更<a class="headerlink" href="#cui" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>NOOBSを使ってRaspbianをインストールすると、グラフィックモードで起動します。
RasPiMouse2019では、通常、ディスプレイを接続しませんので、CUIモードで起動するように設定ます。
起動モードの設定には、raspi-configを用います。</p>
<p>新規にターミナルを起動し、下記のコマンドを実行してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo raspi-config
</pre></div>
</div>
<p>上記のコマンドを実行すると piユーザのパスワードを要求しますので、
Raspbianをインストール時に設定したパスワードを入力してください。
すると、下のようなメニュー画面が表示されますので、
3 Boot Options -&gt; B1 Desktop/CLI の順で選択し、CUIモード(B1またはB2)に変更してください。</p>
<img alt="_images/raspi-config.png" src="_images/raspi-config.png" />
<p>変更終了後、再起動してCUIモードで起動することを確認してください。</p>
</div>
</div>
<div class="section" id="id2">
<h2>RaspberryPiMouseのドライバのインストール<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>搭載するCPUボードへのOSのインストール終了後、RaspberryPiMouse2019にCPUボードを取付け
モータ、センサ制御用のデバイスドライバのインストールを行います。</p>
<div class="section" id="id3">
<h3>RaspberryPiMouseのドライバのインストール<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RaspberryPiMouseのドライバは、<a class="reference external" href="https://github.com/rt-net/RaspberryPiMouse">株式会社アールティのオフィシャルGithub</a>
に公開されています。
RaspberryPiMouseのドライバは、ソースコードからビルドしインストールします。</p>
<p>まず、オフィシャルサイトからソースコードをダウンロードします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir ~/src
$ cd src
$ git clone https://github.com/rt-net/RaspberryPiMouse
</pre></div>
</div>
<p>ドライバのソースコードのダウンロードが正常に終了後、'utils'の下に移動し、
ドライバモジュールのビルドとテストインストールを行います。
ドライバモジュールのビルドには、kernel ヘッダーファイルが必要になりますので、事前にaptコマンドで
インストールしてください。</p>
<p>ドライバモジュールのビルドとテストインストールは、'utils/build_install.bash'で実行することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install raspberrypi-kernel-headers
$ cd ~/src/RaspberryPiMouse/utils
$ ./build_install.bash
</pre></div>
</div>
<p>上記のコマンドを実行後、「ピッ」と音がすれば、ドライバモジュールがインストールされています。
この時、src/drivers　にドライバモジュールとテスト用のバイナリが生成されていますので、
RaspberryPiMouseの動作確認を行うことができす。</p>
<p>この状態では、ドライバモジュールは、~/src/RaspberryPiMouse/src/drivers にあります。
再起動直後にドライバモジュールを読み込むようにするには、ドライバモジュールを
システム用のディレクトリにコピーする必要があります。</p>
<p>そこで、下記のコマンドを実行し、/lib/modules/4.19.75-v7+/kernel/dirversへ
rtmouse.koをコピーしてください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd ~/src/RaspberryPiMouse/src/drivers
$ sudo cp rtmouse.ko /lib/modules/4.19.75-v7+/kernel/drivers
$ sudo depmod
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Raspbianの設定変更とスクリプトの導入<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>次に、再移動直後に RaspberryPiMouseのドライバモジュールが利用できるように設定を行います。
RaspberryPiMouseのドライバは、SPI機能とI2C機能を有効にする必要がありますので、
raspi-configコマンドを使って、SPI機能、I2C機能を「入」にしてください。
SPI機能は、5 Interfacing Options -&gt; P4 SPI で有効化することができ、
I2C機能は、5 Interfacing Options -&gt; P5 I2C で有効化することがでます。</p>
<p>さらに、RaspberryPiMouseの起動時にドライバモジュールの読み込むように、設定を行います。</p>
<p>まず、下記の内容のrtmouse.shを作成し、/etc/init.d/にコピーしてください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#
#
### BEGIN INIT INFO
# Provides:          rtmouse
# Required-Start:    $all
# Required-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:
# Short-Description: RT_Mouse_Driver
# Description:       RaspPiMouse Driver
### END INIT INFO
SCRIPTNAME=rtmouse.sh
PROC_FILE=/proc/modules
GREP=/bin/grep
MODPROBE=/sbin/modprobe
MODULE_NAME=rtmouse
DEP_MODULE_NAME=mcp320x
[ -f $PROC_FILE ] || exit 0
[ -x $GREP ] || exit 0
[ -x $MODPROBE ] || exit 0
RES=`$GREP $MODULE_NAME $PROC_FILE`
install_rtmouse(){
  if [ &quot;$RES&quot; = &quot;&quot; ]; then
    $MODPROBE $MODULE_NAME
    echo &quot;Module Install $MODULE_NAME&quot;
  else
    echo &quot;Module &#39;$MODULE_NAME&#39; is already installed&quot;
  fi
}
remove_rtmouse(){
  if [ &quot;$RES&quot; = &quot;&quot; ]; then
    echo &quot;Module &#39;$MODULE_NAME&#39; isn&#39;t installed yet.&quot;
  else
    $MODPROBE -r $MODULE_NAME
    $MODPROBE -r $DEP_MODULE_NAME
    echo &quot;Module &#39;$MODULE_NAME&#39; is rmoved.&quot;
  fi
}

case &quot;$1&quot; in
  start)
  install_rtmouse
  sleep 1
  /bin/chmod a+rw /dev/rt*
  ;;
  stop)
  remove_rtmouse
  ;;
  status)
    if [ &quot;$RES&quot; = &quot;&quot; ]; then
      echo &quot;Module &#39;$MODULE_NAME&#39; isn&#39;t installed yet.&quot;
      exit 0
    else
      echo &quot;Module &#39;$MODULE_NAME&#39; is already installed&quot;
      exit 0
    fi
  ;;
  *)
    echo &quot;Usage: $SCRIPTNAME {start|stop|status}&quot; &gt;&amp;2
    exit 3
esac
exit 0
</pre></div>
</div>
<p>次に、rtmouse.koを起動時systemdによる自動起動を行うために、下記の内容のファイルを作成し、
/etc/systemd/system/rtmouse.service という名前で配置してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">rtmouse</span> <span class="n">driver</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rtmouse</span><span class="o">.</span><span class="n">sh</span> <span class="n">start</span>
<span class="n">ExecReload</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rtmouse</span><span class="o">.</span><span class="n">sh</span> <span class="n">restart</span>
<span class="n">ExecStopt</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rtmouse</span><span class="o">.</span><span class="n">sh</span> <span class="n">stop</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
<p>最後に、上記で作成してsystemdの設定の有効化を行うために下記のコマンドを実行してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo sysremctl enable rtmouse
</pre></div>
</div>
<p>以上で、systemdによるドライバをインストールできるようになりますので、再起動して動作確認を行ってください。
起動時に「ピッ」という音が鳴れば、ドライバのインストールが正常に動作しています。</p>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">RaspberryPiMouseのセットアップ</a><ul>
<li><a class="reference internal" href="#raspberrypi-3b-os">RaspberryPi 3B+へOSのインストール</a></li>
<li><a class="reference internal" href="#id2">RaspberryPiMouseのドライバのインストール</a></li>
</ul>
</li>
</ul>

  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/raspbian_setup.rst.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="総合索引"
             >索引</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Navigation  ドキュメント</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RaspberryPiMouseのセットアップ</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Isao Hara.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>